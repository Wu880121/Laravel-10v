name: CI/CD Pipeline for Laravel + Docker Image Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: kocoimur0003/laravel-10v

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v3

      - name: â° Generate Docker Image Tag
        id: tag
        run: |
          git fetch --tags
          TODAY=$(date +"%Y%m%d")
          COUNT=$(git tag | grep "${TODAY}_V" | wc -l)
          VERSION=$((COUNT+1))
          TAG="${TODAY}_V${VERSION}"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: ğŸ” Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: âš™ï¸ å®‰è£å‰ç«¯è³‡æºä¸¦ç·¨è­¯ Vite
        run: |
          npm ci
          npm run build

      - name: ğŸ³ Build & Push Docker Image
        run: |
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:${{ env.TAG }} .
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ env.TAG }}

      # âœ… åŠ ä¸Šè‡ªå‹•æ¸…é™¤ç©ºé–“çš„ä»»å‹™
      - name: ğŸ§½ Clean Up EC2 Docker Space (Before Deploy)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "âš ï¸ æ¸…é™¤æ²’åœ¨ç”¨çš„ Docker è³‡æºä»¥é‡‹æ”¾ç£ç¢Ÿç©ºé–“..."
            docker system prune -af --volumes || true
            echo "âœ… å·²æ¸…é™¤ Docker ç³»çµ±è³‡æº"

      - name: ğŸš€ Deploy to EC2 (PHP + Nginx)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            IMAGE_NAME=${{ env.IMAGE_NAME }}
            TAG=${{ env.TAG }}

            echo "ğŸ“ å»ºç«‹å¿…è¦è³‡æ–™å¤¾"
            mkdir -p /home/ec2-user/laravel-10v/public
            mkdir -p /home/ec2-user/laravel-10v/storage/app/public
            mkdir -p /home/ec2-user/laravel-10v/storage/framework/{cache,sessions,views}
            mkdir -p /home/ec2-user/laravel-10v/storage/logs
            mkdir -p /home/ec2-user/laravel-10v/nginx

            echo "ğŸ§© æª¢æŸ¥ .env æ˜¯å¦å­˜åœ¨"
            if [ ! -f "/home/ec2-user/laravel-10v/.env" ]; then
              echo "âŒ ç¼ºå°‘ .env æª”æ¡ˆï¼Œè«‹å…ˆä¸Šå‚³"
              exit 1
            fi

            echo "ğŸ“¥ æ‹‰å–æœ€æ–° Laravel Imageï¼š$TAG"
            docker pull $IMAGE_NAME:$TAG

            echo "ğŸ§¹ åœæ­¢ä¸¦ç§»é™¤èˆŠå®¹å™¨"
            docker stop laravel-app || true
            docker rm laravel-app || true
            docker stop nginx-server || true
            docker rm nginx-server || true

            echo "ğŸ˜ å•Ÿå‹• Laravel App å®¹å™¨ï¼ˆæ›è¼‰ storage, public, .envï¼‰"
            docker run -d --name laravel-app \
              --restart unless-stopped \
              --network laravel-net \
              -v /home/ec2-user/laravel-10v/storage:/var/www/html/storage \
              -v /home/ec2-user/laravel-10v/public:/var/www/html/public \
              -v /home/ec2-user/laravel-10v/.env:/var/www/html/.env \
              $IMAGE_NAME:$TAG

            echo "ğŸ”— å»ºç«‹ storage:link èˆ‡ä¿®æ­£æ¬Šé™"
            docker exec laravel-app chown -R www-data:www-data /var/www/html/storage
            docker exec laravel-app php artisan storage:link
            
            echo "ğŸ§ª åŸ·è¡Œ Laravel åˆå§‹åŒ–æŒ‡ä»¤"
            docker exec laravel-app chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
            docker exec laravel-app chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache
            docker exec laravel-app php artisan key:generate
            docker exec laravel-app php artisan config:cache
            docker exec laravel-app php artisan route:cache
            docker exec laravel-app php artisan view:cache            


            echo "ğŸ§½ æ¸…é™¤ 24 å°æ™‚å‰æœªä½¿ç”¨çš„ image"
            docker image prune -af --filter "until=24h"
