name: CI/CD for Laravel + Docker Compose

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: kocoimur0003/laravel-10v

    steps:
      - name: ‚úÖ Checkout Code
        uses: actions/checkout@v4

      - name: ‚è∞ Generate Docker Image Tag
        id: tag
        run: |
          git fetch --tags
          TODAY=$(date +"%Y%m%d")
          COUNT=$(git tag | grep "${TODAY}_V" | wc -l)
          VERSION=$((COUNT+1))
          TAG="${TODAY}_V${VERSION}"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: üîê Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ‚öôÔ∏è Install Frontend Dependencies and Build Vite
        run: |
          npm ci
          npm run build

      - name: üê≥ Build and Push Docker Image
        run: |
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:${{ env.TAG }} .
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ env.TAG }}

      - name: üßΩ Clean Up EC2 Docker Space
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker system prune -af --volumes || true

      - name: üöÄ Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/laravel-10v

            echo "üöë Pull latest code"
            git pull origin main

            echo "üõ†Ô∏è Updating image version in docker-compose.override.yml"
            echo "version: '3.8'" > docker-compose.override.yml
            echo "services:" >> docker-compose.override.yml
            echo "  laravel-app:" >> docker-compose.override.yml
            echo "    image: kocoimur0003/laravel-10v:${{ env.TAG }}" >> docker-compose.override.yml

            echo "‚õîÔ∏è Stopping current containers"
            docker-compose down

            echo "‚ö°Ô∏è Starting new containers"
            docker-compose up -d

            echo "üåÅ Laravel Artisan Commands"
            docker-compose exec laravel-app php artisan storage:link || true
            docker-compose exec laravel-app php artisan config:cache
            docker-compose exec laravel-app php artisan route:cache
            docker-compose exec laravel-app php artisan view:cache
            docker-compose exec laravel-app php artisan migrate --force || true

      - name: ‚ùÑÔ∏è Clean up old images
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker image prune -af --filter "until=24h"
