name: CI/CD Pipeline for Laravel + Docker Image Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: kocoimur0003/laravel-10v

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v3

      - name: â° Generate Docker Image Tag
        id: tag
        run: |
          git fetch --tags
          TODAY=$(date +"%Y%m%d")
          COUNT=$(git tag | grep "${TODAY}_V" | wc -l)
          VERSION=$((COUNT+1))
          TAG="${TODAY}_V${VERSION}"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: ğŸ” Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ğŸ³ Build & Push Docker Image
        run: |
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:${{ env.TAG }} .
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ env.TAG }}

      - name: ğŸš€ Deploy to EC2 (PHP + Nginx)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            IMAGE_NAME=${{ env.IMAGE_NAME }}
            TAG=${{ env.TAG }}

            echo "ğŸ“ å»ºç«‹ Laravel éƒ¨ç½²è³‡æ–™å¤¾"
            mkdir -p /home/ec2-user/laravel-10v-deploy/storage/app/public
            mkdir -p /home/ec2-user/laravel-10v-deploy/storage/framework/{cache,sessions,views}
            mkdir -p /home/ec2-user/laravel-10v-deploy/storage/logs
            mkdir -p /home/ec2-user/laravel-10v-deploy/nginx

            echo "ğŸ”§ æª¢æŸ¥æ˜¯å¦å­˜åœ¨ public è³‡æ–™å¤¾ï¼Œè‹¥ç„¡å‰‡å»ºç«‹"
            if [ ! -d "/home/ec2-user/laravel-10v-deploy/public" ]; then
              echo "âš ï¸ public è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå»ºç«‹ä¸­..."
              mkdir -p /home/ec2-user/laravel-10v-deploy/public
              chown -R ec2-user:ec2-user /home/ec2-user/laravel-10v-deploy/public
              chmod -R 775 /home/ec2-user/laravel-10v-deploy/public
            fi

            echo "ğŸ“¥ æ‹‰å–æœ€æ–° Laravel Image"
            docker pull $IMAGE_NAME:$TAG

            echo "ğŸ§¹ åœæ­¢ä¸¦ç§»é™¤èˆŠ PHP å®¹å™¨"
            docker stop laravel-app || true
            docker rm laravel-app || true

            echo "ğŸ˜ å•Ÿå‹• Laravel å®¹å™¨"
            docker run -d --name laravel-app \
              --restart unless-stopped \
              -v /home/ec2-user/laravel-10v-deploy:/var/www/html \
              $IMAGE_NAME:$TAG

            echo "ğŸ”— å»ºç«‹ storage:link èˆ‡æ¬Šé™è¨­å®š"
            docker exec laravel-app chown -R www-data:www-data /var/www/html/storage
            docker exec laravel-app php artisan storage:link

            echo "ğŸ§¹ åœæ­¢ä¸¦ç§»é™¤èˆŠ Nginx å®¹å™¨"
            docker stop nginx-server || true
            docker rm nginx-server || true

            echo "ğŸŒ å•Ÿå‹• Nginx å®¹å™¨"
            docker run -d --name nginx-server \
              --restart unless-stopped \
              -p 8080:80 \
              -v /home/ec2-user/laravel-10v-deploy:/var/www/html \
              -v /home/ec2-user/laravel-10v-deploy/nginx/default.conf:/etc/nginx/conf.d/default.conf \
              nginx:alpine

            echo "ğŸ§½ æ¸…é™¤ 24 å°æ™‚å‰æœªä½¿ç”¨çš„ image"
            docker image prune -af --filter "until=24h"
